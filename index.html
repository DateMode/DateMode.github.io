<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>DM｜DateMode 台灣高端匿名交友</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  /* [所有 CSS 樣式保持原樣，並未大改，因為排版已優雅] */
  :root{
    --p:#c084fc;--ph:#e9d5ff;--bg:#0a0619;--card:#1a0f38;--glass:rgba(30,15,56,0.65);
    --text:#e0d0ff;--muted:#b19cd9;--glow:rgba(192,132,252,0.4);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; /* 字體優化 */
    background:var(--bg);
    color:var(--text);
    height:100vh;
    overflow:hidden;
    background:radial-gradient(circle at 20% 80%, #2a1a5e, #0a0619);
    display: flex; /* 確保全螢幕佈局 */
    flex-direction: column;
  }

  /* 18禁彈窗 – 頂級質感 */
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,0.96);display:flex;align-items:center;justify-content:center;z-index:999;
    backdrop-filter:blur(12px);
  }
  .modal-box{
    background:var(--glass);padding:3rem 2.5rem;border-radius:32px;
    border:1px solid var(--glow);box-shadow:0 25px 80px rgba(192,132,252,0.35);
    max-width:440px;width:92%;text-align:center;
  }
  .modal-box h2{
    background:linear-gradient(90deg,#ff6b6b,#ff8e8e);
    -webkit-background-clip:text;color:transparent;
    font-size:2rem;margin-bottom:1.2rem;
  }

  /* 登入選單 – 極致優雅 */
  #login{
    padding:2rem 1.5rem;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;
    background:linear-gradient(to bottom, rgba(26,15,56,0.9), var(--bg));
    position: absolute; /* 讓它完全覆蓋，不受聊天室佈局影響 */
    inset: 0;
  }
  #login h1{
    font-size:2.6rem;margin-bottom:0.4rem;
    background:linear-gradient(90deg,#c084fc,#e0aaff,#f8b7ff);
    -webkit-background-clip:text;color:transparent;letter-spacing:3px;
  }
  #login > p{
    color:var(--muted);margin:1.2rem 0 2rem;font-size:1.15rem;opacity:0.9;
  }

  /* 真實 IP 顯示框 */
  .ip-box{
    background:rgba(192,132,252,0.15);
    border:1px solid rgba(192,132,252,0.5);
    padding:16px 24px;border-radius:20px;margin:25px 0;
    font-size:1.05rem;backdrop-filter:blur(10px);
    box-shadow:0 8px 25px rgba(0,0,0,0.3);
  }

  /* 超精緻按鈕群 */
  .room-grid{
    display:grid;grid-template-columns:repeat(2,1fr);gap:20px;width:100%;max-width:460px;margin:35px 0;
  }
  .room-btn{
    background:linear-gradient(135deg,rgba(192,132,252,0.22),rgba(224,170,255,0.12));
    border:1px solid rgba(192,132,252,0.6);
    color:white;padding:24px 18px;border-radius:26px;
    font-size:1.18rem;font-weight:600;letter-spacing:1.5px;
    transition:all .4s ease;box-shadow:0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter:blur(12px);
    cursor: pointer; /* 加上指標 */
  }
  .room-btn:hover{
    transform:translateY(-10px) scale(1.03);
    box-shadow:0 20px 50px rgba(192,132,252,0.5);
    border-color:var(--p);
  }
  .room-btn i{margin-right:10px;font-size:1.4rem;}

  /* 退出按鈕 (在登入介面會隱藏) */
  #backBtn.chat-visible{ /* 修正：將樣式移到這，避免與 #login 介面重疊 */
    position:fixed;top:20px;left:20px;z-index:99;
    background:rgba(0,0,0,0.5);border:none;color:white;padding:12px 18px;
    border-radius:50px;font-size:1rem;cursor:pointer;backdrop-filter:blur(8px);
    box-shadow:0 4px 15px rgba(0,0,0,0.4);
  }
  #backBtn.chat-visible:hover{background:var(--p);color:#000;}

  /* 聊天介面 - 佈局優化 */
  #chat-container{
    display: flex;
    flex-direction: column;
    flex: 1; /* 佔滿剩餘空間 */
    height: 100vh;
  }

  header{
    background:var(--card);padding:1.1rem;text-align:center;position:relative;
    box-shadow:0 12px 35px rgba(0,0,0,0.7);backdrop-filter:blur(10px);
  }
  #roomTitle{
    font-size:1.75rem;background:linear-gradient(90deg,#c084fc,#e0aaff);
    -webkit-background-clip:text;color:transparent;
  }
  #online{
    position:absolute;right:16px;top:50%;transform:translateY(-50%);
    background:rgba(192,132,252,0.35);padding:7px 16px;border-radius:30px;font-size:0.95rem;
  }

  #messages{
    flex:1;overflow-y:auto;padding:1.6rem 1.2rem;display:flex;flex-direction:column;gap:18px;
    background:linear-gradient(to bottom, rgba(26,15,56,0.5), var(--bg));
  }
  .msg{
    max-width:78%;align-self:flex-start;animation:msgIn 0.5s ease-out;
  }
  .msg.own{align-self:flex-end;}
  @keyframes msgIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:none;}}
  .bubble{
    background:var(--card);padding:16px 22px;border-radius:28px;
    box-shadow:0 8px 28px rgba(0,0,0,0.5);border:1px solid rgba(192,132,252,0.3);
  }
  .msg.own .bubble{
    background:linear-gradient(135deg,#d8b4fe,#c084fc);color:#000;
    border-bottom-right-radius:8px;
  }
  .msg.other .bubble{border-bottom-left-radius:8px;}
  .head{display:flex;align-items:center;gap:14px;margin-bottom:8px;}
  .avatar{
    width:46px;height:46px;border-radius:50%;border:2px solid var(--p);object-fit:cover;
  }
  .info{font-size:0.9rem;color:var(--muted);margin-top:10px;}
  .info span{color:#faf5ff;font-weight:600;}

  footer{
    background:var(--card);padding:1.2rem;border-top:2px solid var(--p));
    box-shadow:0 -12px 40px rgba(0,0,0,0.7);
  }
  .input-area{display:flex;align-items:end;gap:14px;}
  textarea{
    flex:1;padding:18px;border-radius:26px;background:rgba(45,27,105,0.7);
    border:1px solid var(--p);color:white;font-size:1.1rem;min-height:56px;
    resize:none;backdrop-filter:blur(8px);
  }
  textarea:focus{outline:none;background:rgba(61,42,142,0.9);}
  button{
    background:var(--p);border:none;width:60px;height:60px;border-radius:50%;
    font-size:1.8rem;color:#000;cursor:pointer;
    box-shadow:0 8px 30px rgba(192,132,252,0.6);transition:.3s;
  }
  button:hover{transform:scale(1.15);}
  .private-toggle{
    position:absolute;right:16px;top:50%;transform:translateY(-50%);
    background:rgba(0,0,0,0.5);padding:8px 16px;border-radius:30px;
    font-size:0.95rem;display:flex;align-items:center;gap:8px;
    backdrop-filter:blur(8px);
  }
  .hidden{display:none !important;}
</style>
</head>
<body>

<div id="chat-container" class="hidden">
    <button id="backBtn" onclick="location.reload()">
      <i class="fas fa-arrow-left"></i> 退出房間
    </button>
    <header id="header">
      <h1 id="roomTitle">聊天室</h1>
      <div id="online">0 人</div>
      <div class="private-toggle">
        <input type="checkbox" id="privateMode">
        <label for="privateMode">私密對話</label>
      </div>
    </header>
    <main id="messages"></main>
    <footer id="footer">
      <div class="input-area">
        <textarea id="input" placeholder="說點什麼…（Enter送出）"></textarea>
        <button onclick="send()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </footer>
</div>

<div class="modal">
  <div class="modal-box">
    <h2>DM｜DateMode 18+ 使用條款</h2>
    <div style="line-height:2;font-size:1.1rem;margin:1.5rem 0;">
      <ul style="text-align:left;margin-left:1.5rem;">
        <li>僅限滿18歲成年人士使用</li>
        <li>嚴禁金錢交易、援交廣告</li>
        <li>禁止散布違法或騷擾內容</li>
        <li>一切言論由使用者自行負責</li>
      </ul>
      <p style="color:#ff6b6b;margin-top:1.8rem;font-weight:bold;">按下同意即表示您已滿18歲</p>
    </div>
    <button onclick="document.querySelector('.modal').remove();showLogin()" 
            style="background:#10b981;width:100%;padding:18px;margin-top:25px;border-radius:20px;font-size:1.2rem;">
      我已滿18歲，同意並進入
    </button>
  </div>
</div>

<div id="login" class="hidden">
  <h1>DM｜DateMode</h1>
  <p>台灣最安全高端匿名交友平台</p>
  
  <div class="ip-box" id="ipInfo">正在取得您的真實位置…</div>
  
  <div id="googleBtn" style="margin:25px auto;"></div>
  
  <input type="text" id="nick" placeholder="輸入暱稱（最多10字）" maxlength="10" 
         style="width:100%;max-width:380px;padding:16px;border-radius:20px;background:rgba(45,27,105,0.6);border:1px solid var(--p);text-align:center;margin:20px 0;font-size:1.1rem;">
  
  <div class="room-grid">
    <button class="room-btn" onclick="enter('short')"><i class="fas fa-bolt"></i> 短期約會</button>
    <button class="room-btn" onclick="enter('long')"><i class="fas fa-heart"></i> 長期約會</button>
    <button class="room-btn" onclick="enter('group')"><i class="fas fa-users"></i> 多人聯誼</button>
    <button class="room-btn" onclick="enter('gay')"><i class="fas fa-venus-mars"></i> 男同志</button>
    <button class="room-btn" onclick="enter('lesbian')"><i class="fas fa-venus"></i> 女同志</button>
    <button class="room-btn" onclick="showCities()"><i class="fas fa-map-marker-alt"></i> 依地區</button>
  </div>

  <select id="citySelect" class="hidden" onchange="this.value && enter('city')"> <option value="">選擇縣市…</option>
    <option>台北市</option><option>新北市</option><option>桃園市</option><option>台中市</option><option>台南市</option><option>高雄市</option>
    <option>基隆市</option><option>新竹市</option><option>嘉義市</option><option>新竹縣</option><option>苗栗縣</option><option>彰化縣</option>
    <option>南投縣</option><option>雲林縣</option><option>嘉義縣</option><option>屏東縣</option><option>宜蘭縣</option><option>花蓮縣</option>
    <option>台東縣</option><option>澎湖縣</option><option>金門縣</option><option>連江縣</option>
  </select>
</div>


<script>
const API = "https://123gocorp.com"; // 假設這是您的 PHP 後端 API 根地址 (例如: https://yourdomain.com/api.php)

let room = "", nick = "匿名", googleUser = null, ip = "", city = "未知地區", privateTo = null;
let lastMessageId = 0; // 用於 load() 判斷是否有新訊息

// ----------------------------------------------------
// 取得 IP / 位置 資訊
// ----------------------------------------------------
async function getLocation(){
  // [getLocation 函數邏輯不變，保持原樣]
  try{
    const r = await fetch("https://api.ipify.org?format=json");
    const {ip:addr} = await r.json();
    ip = addr;
    const r2 = await fetch(`https://ipapi.co/${ip}/json/`);
    const d = await r2.json();
    city = d.country_name==="Taiwan" ? (d.region || "台灣") : "國外";
    document.getElementById("ipInfo").innerHTML = `
      <i class="fas fa-map-marker-alt"></i> 您目前在：<strong>${city}</strong><br>
      <small style="opacity:0.8;">IP：${ip}</small>
    `;
  }catch(e){
    document.getElementById("ipInfo").textContent = "位置取得失敗";
  }
}

// ----------------------------------------------------
// 登入介面顯示與 Google 登入初始化
// ----------------------------------------------------
function showLogin(){
  getLocation();
  google.accounts.id.initialize({
    client_id: "1039614426685-4v0g4u1g5p8f0b8gq8v8gq8v8gq8v8gq.apps.googleusercontent.com",
    callback: r=>{
      const p = JSON.parse(atob(r.credential.split('.')[1]));
      googleUser = p;
      nick = p.name;
      document.getElementById("nick").value = nick;
    }
  });
  google.accounts.id.renderButton(document.getElementById("googleBtn"), {theme:"outline", size:"large", shape:"pill"});
  document.getElementById("login").classList.remove("hidden");
}

function showCities(){
  document.getElementById("citySelect").classList.remove("hidden");
}

// ----------------------------------------------------
// 進入聊天室
// ----------------------------------------------------
function enter(r){
  const inputNick = document.getElementById("nick").value.trim();
  if(!inputNick && !googleUser){
    alert("請輸入暱稱或使用 Google 登入");
    return;
  }
  nick = (googleUser?.name || inputNick).slice(0,10);
  if(r==="city"){
    const c = document.getElementById("citySelect").value;
    if(!c){ alert("請選擇縣市"); return; }
    room = "city_"+c;
    document.getElementById("roomTitle").textContent = c + "聊天室";
  }else{
    room = r;
    const names = {short:"短期約會",long:"長期約會",group:"多人聯誼",gay:"男同志",lesbian:"女同志"};
    document.getElementById("roomTitle").textContent = names[r] || "聊天室";
  }
  localStorage.setItem("dm_nick",nick);
  document.getElementById("login").classList.add("hidden");
  document.getElementById("chat-container").classList.remove("hidden"); // 顯示聊天容器
  document.getElementById("backBtn").classList.add("chat-visible"); // 顯示退出按鈕
  
  // 開始載入訊息
  load();
  setInterval(load, 3500);
}

// ----------------------------------------------------
// 訊息渲染 (優化)
// ----------------------------------------------------
function renderMessage(msg) {
    // 檢查訊息是否為私密且不是發給自己或自己發的，則忽略
    if (msg.private_to && msg.private_to !== nick && msg.nickname !== nick) {
        return '';
    }

    const isOwn = msg.nickname === nick;
    const avatar = msg.avatar || 'https://via.placeholder.com/150/808080/FFFFFF?text=DM';
    let avatarStyle = '';

    // 匿名用戶和 Google 用戶的頭像處理 (這裡假設Google用戶會帶有msg.avatar)
    if (!msg.avatar) {
        // 為匿名用戶創建一個基於暱稱的顏色
        const hash = Array.from(msg.nickname).reduce((sum, char) => sum + char.charCodeAt(0), 0);
        const color = `hsl(${hash % 360}, 70%, 70%)`;
        avatarStyle = `background-color: ${color}; border-color: ${color}; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;`;
        avatarText = msg.nickname.charAt(0);
    }
    
    // 檢查是否為私密訊息
    const isPrivate = msg.private_to;
    let privateIndicator = '';
    if (isPrivate) {
        privateIndicator = `<span style="color:#ffcc00; font-size:0.9em; margin-left:10px;"><i class="fas fa-lock"></i> 私密</span>`;
    }
    
    const html = `
        <div class="msg ${isOwn ? 'own' : 'other'}">
            <div class="head">
                ${!isOwn ? `<img class="avatar" src="${msg.avatar ? msg.avatar : 'https://via.placeholder.com/46'}" alt="${msg.nickname}" style="${avatarStyle}">` : ''}
                <strong style="color: ${isOwn ? '#c084fc' : '#e0aaff'};">${msg.nickname}</strong>
                ${!isOwn ? privateIndicator : ''}
            </div>
            <div class="bubble">
                ${msg.message.replace(/\n/g, '<br>')}
                <div class="info">
                    ${isOwn ? privateIndicator : ''}
                    <span>${new Date(msg.created_at).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span> 
                    - ${msg.city}
                </div>
            </div>
        </div>
    `;
    return html;
}

// ----------------------------------------------------
// 載入訊息 (補齊)
// ----------------------------------------------------
async function load() {
    try {
        const response = await fetch(`${API}?action=messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room, nickname: nick }) // 傳送暱稱用於判斷私密訊息
        });
        const messages = await response.json();
        
        if (messages.error) {
            console.error('後端錯誤:', messages.error);
            return;
        }

        const msgsContainer = document.getElementById("messages");
        
        // 判斷是否有新訊息，避免重複渲染
        if (messages.length > 0 && messages[messages.length - 1].id !== lastMessageId) {
            msgsContainer.innerHTML = messages.map(renderMessage).join('');
            lastMessageId = messages[messages.length - 1].id;
            msgsContainer.scrollTop = msgsContainer.scrollHeight; // 自動滾到底部
        }
        
        // 更新在線人數 (這裡我們假設後端會傳送在線人數，但由於後端被省略，我們用一個隨機數代替，您需要根據後端調整)
        // 實際情況：後端需要額外寫入邏輯來計算在線人數
        document.getElementById("online").textContent = `${messages.length + Math.floor(Math.random() * 10) + 1} 人`; 

    } catch (e) {
        console.error("載入訊息失敗:", e);
        // 可以顯示一個錯誤提示給用戶
    }
}

// ----------------------------------------------------
// 發送訊息 (補齊)
// ----------------------------------------------------
async function send() {
    const inputField = document.getElementById("input");
    const message = inputField.value.trim();
    if (!message) return;

    try {
        const response = await fetch(`${API}?action=send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                room,
                nickname: nick,
                message: message,
                googleUser, // 傳送 Google 資訊
                ip,
                city,
                // private_to: privateTo // 如果實作私密對話，這裡需要邏輯來設定目標暱稱
            })
        });

        const result = await response.json();
        if (result.success) {
            inputField.value = ''; // 清空輸入框
            load(); // 重新載入訊息以顯示新發送的內容
        } else {
            alert("發送失敗，請稍後再試！");
        }

    } catch (e) {
        console.error("發送訊息失敗:", e);
        alert("網路錯誤或後端連線中斷。");
    }
}


// ----------------------------------------------------
// 事件監聽 (Enter 送出)
// ----------------------------------------------------
document.addEventListener("keydown",e=>{
    const inputField = document.getElementById("input");
    if(e.key==="Enter" && !e.shiftKey && inputField && document.getElementById("chat-container") && !document.getElementById("chat-container").classList.contains('hidden')){
        e.preventDefault();
        send();
    }
});

// ----------------------------------------------------
// 初始檢查
// ----------------------------------------------------
if(localStorage.dm_nick) document.getElementById("nick").value=localStorage.dm_nick;

// 確保一開始就執行彈窗邏輯
// 注意: 由於 body 初始是隱藏聊天容器，這裡不需要在彈窗後顯示登入介面，而是由彈窗的按鈕去觸發 showLogin()
</script>
</body>
</html>
