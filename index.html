<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>DM｜DateMode 台灣高端匿名交友</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root{
    --p:#c084fc;--ph:#e9d5ff;--bg:#0a0619;--card:#1a0f38;--glass:rgba(30,15,56,0.65);
    --text:#e0d0ff;--muted:#b19cd9;--glow:rgba(192,132,252,0.4);
    /* 性別顏色 */
    --male:#3b82f6; 
    --female:#f472b6;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
    background:var(--bg);
    color:var(--text);
    height:100vh;
    overflow:hidden;
    background:radial-gradient(circle at 20% 80%, #2a1a5e, #0a0619);
    display: flex;
    flex-direction: column;
  }

  /* 18禁彈窗 */
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,0.96);display:flex;align-items:center;justify-content:center;z-index:999;
    backdrop-filter:blur(12px);
  }
  .modal-box{
    background:var(--glass);padding:3rem 2.5rem;border-radius:32px;
    border:1px solid var(--glow);box-shadow:0 25px 80px rgba(192,132,252,0.35);
    max-width:440px;width:92%;text-align:center;
  }
  .modal-box h2{
    background:linear-gradient(90deg,#ff6b6b,#ff8e8e);
    -webkit-background-clip:text;color:transparent;
    font-size:2rem;margin-bottom:1.2rem;
  }

  /* 登入選單 */
  #login{
    padding:2rem 1.5rem;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;
    background:linear-gradient(to bottom, rgba(26,15,56,0.9), var(--bg));
    position: absolute;
    inset: 0;
  }
  #login h1{
    font-size:2.6rem;margin-bottom:0.4rem;
    background:linear-gradient(90deg,#c084fc,#e0aaff,#f8b7ff);
    -webkit-background-clip:text;color:transparent;letter-spacing:3px;
  }
  #login > p{
    color:var(--muted);margin:1.2rem 0 2rem;font-size:1.15rem;opacity:0.9;
  }

  /* 暱稱輸入框優化 */
  #nick{
    width:100%;max-width:380px;padding:16px;border-radius:20px;
    background:rgba(45,27,105,0.6);border:1px solid var(--p);
    text-align:center;margin:20px 0 10px;font-size:1.1rem;
    color: white; 
  }
  #nick::placeholder {
      color: rgba(255, 255, 255, 0.6);
  }

  /* 性別選擇器樣式 */
  .gender-selection {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
  }
  .gender-selection label {
      cursor: pointer;
      padding: 10px 20px;
      border-radius: 20px;
      border: 1px solid var(--muted);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
  }
  .gender-selection input:checked + label.male {
      background: var(--male);
      border-color: var(--male);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
  }
  .gender-selection input:checked + label.female {
      background: var(--female);
      border-color: var(--female);
      box-shadow: 0 0 15px rgba(244, 114, 182, 0.5);
  }
  .gender-selection input { display: none; }


  /* 真實 IP 顯示框 */
  .ip-box{
    background:rgba(192,132,252,0.15);
    border:1px solid rgba(192,132,252,0.5);
    padding:16px 24px;border-radius:20px;margin:25px 0;
    font-size:1.05rem;backdrop-filter:blur(10px);
    box-shadow:0 8px 25px rgba(0,0,0,0.3);
  }

  /* 超精緻按鈕群 */
  .room-grid{
    display:grid;grid-template-columns:repeat(2,1fr);gap:20px;width:100%;max-width:460px;margin:35px 0;
  }
  .room-btn{
    background:linear-gradient(135deg,rgba(192,132,252,0.22),rgba(224,170,255,0.12));
    border:1px solid rgba(192,132,252,0.6);
    color:white;padding:18px 12px; 
    border-radius:26px;
    font-size:1.05rem; 
    font-weight:600;letter-spacing:1px; 
    transition:all .4s ease;box-shadow:0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter:blur(12px);
    cursor: pointer;
    text-align: center; 
  }
  .room-btn:hover{
    transform:translateY(-10px) scale(1.03);
    box-shadow:0 20px 50px rgba(192,132,252,0.5);
    border-color:var(--p);
  }
  .room-btn i{margin-right:8px;font-size:1.2rem;}

  /* 退出按鈕 */
  #backBtn{
    position:fixed;top:20px;left:20px;z-index:100;
    background:rgba(0,0,0,0.5);border:none;color:white;padding:12px 18px;
    border-radius:50px;font-size:1rem;cursor:pointer;backdrop-filter:blur(8px);
    box-shadow:0 4px 15px rgba(0,0,0,0.4);
    transition: 0.3s;
  }
  #backBtn:hover{background:var(--p);color:#000;}


  /* 聊天介面 - 佈局優化 */
  #chat-container{
    display: flex;
    flex-direction: column;
    flex: 1; 
    height: 100vh;
  }
  
  /* 主要三欄式佈局 */
  .chat-main-area {
      display: flex;
      flex: 1;
      overflow: hidden;
  }

  /* 右側訪客列表 */
  #usersList {
      width: 200px; 
      background: var(--card);
      padding: 1.5rem;
      overflow-y: auto;
      box-shadow: -5px 0 20px rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      flex-shrink: 0; 
  }
  #usersList h3 {
      font-size: 1.2rem;
      color: var(--p);
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(192, 132, 252, 0.3);
      padding-bottom: 8px;
  }
  #usersList ul {
      list-style: none;
      padding: 0;
  }
  #usersList li {
      padding: 6px 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
  }
  .user-online-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      flex-shrink: 0;
  }
  .user-gender-male { color: var(--male); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .user-gender-female { color: var(--female); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }


  /* 聊天室 Header */
  header{
    background:var(--card);padding:1.1rem;text-align:center;position:relative;
    box-shadow:0 12px 35px rgba(0,0,0,0.7);backdrop-filter:blur(10px);
    padding-bottom: 0.5rem; 
  }
  #roomTitle{
    font-size:1.75rem;background:linear-gradient(90deg,#c084fc,#e0aaff);
    -webkit-background-clip:text;color:transparent;
  }
  
  /* 使用者資訊區塊 */
  #userInfo {
      margin: 5px 0 10px;
      font-size: 0.9rem;
      color: var(--muted);
      padding: 0 20px;
      text-align: left;
  }
  #userInfo strong {
      color: var(--text);
      margin-right: 15px;
  }

  #online{
    position:absolute;right:16px;top:20px;
    background:rgba(192,132,252,0.35);padding:7px 16px;border-radius:30px;font-size:0.95rem;
  }
  
  /* 訊息區塊 */
  #messages{
    flex:1;overflow-y:auto;padding:1.6rem 1.2rem;display:flex;flex-direction:column;gap:18px;
    background:linear-gradient(to bottom, rgba(26,15,56,0.5), var(--bg));
  }
  .msg{
    max-width:78%;align-self:flex-start;animation:msgIn 0.5s ease-out;
  }
  .msg.own{align-self:flex-end;}
  @keyframes msgIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:none;}}
  .bubble{
    background:var(--card);padding:16px 22px;border-radius:28px;
    box-shadow:0 8px 28px rgba(0,0,0,0.5);border:1px solid rgba(192,132,252,0.3);
  }
  .msg.own .bubble{
    background:linear-gradient(135deg,#d8b4fe,#c084fc);color:#000;
    border-bottom-right-radius:8px;
  }
  .msg.other .bubble{border-bottom-left-radius:8px;}
  .head{display:flex;align-items:center;gap:14px;margin-bottom:8px;}
  .avatar{
    width:46px;height:46px;border-radius:50%;border:2px solid var(--p);object-fit:cover;
  }
  .info{font-size:0.9rem;color:var(--muted);margin-top:10px;}
  .info span{color:#faf5ff;font-weight:600;}
  .nickname-male { color: var(--male) !important; font-weight: bold; }
  .nickname-female { color: var(--female) !important; font-weight: bold; }

  /* Footer 輸入區 */
  footer{
    background:var(--card);padding:1.2rem;border-top:2px solid var(--p));
    box-shadow:0 -12px 40px rgba(0,0,0,0.7);
    flex-shrink: 0;
  }
  .input-area{display:flex;align-items:end;gap:14px;}
  textarea{
    flex:1;padding:18px;border-radius:26px;background:rgba(45,27,105,0.7);
    border:1px solid var(--p);color:white;font-size:1.1rem;min-height:56px;
    resize:none;backdrop-filter:blur(8px);
  }
  textarea:focus{outline:none;background:rgba(61,42,142,0.9);}
  button{
    background:var(--p);border:none;width:60px;height:60px;border-radius:50%;
    font-size:1.8rem;color:#000;cursor:pointer;
    box-shadow:0 8px 30px rgba(192,132,252,0.6);transition:.3s;
  }
  button:hover{transform:scale(1.15);}
  .private-toggle{
    position:absolute;right:16px;bottom:10px;
    background:rgba(0,0,0,0.5);padding:8px 16px;border-radius:30px;
    font-size:0.95rem;display:flex;align-items:center;gap:8px;
    backdrop-filter:blur(8px);
  }
  .hidden{display:none !important;}
</style>
</head>
<body>

<div id="chat-container" class="hidden">
    <button id="backBtn" onclick="location.reload()">
      <i class="fas fa-arrow-left"></i> 退出房間
    </button>
    <header id="header">
      <h1 id="roomTitle">聊天室</h1>
      <div id="online">0 人</div>
      <div id="userInfo">
        暱稱: <strong id="userNickDisplay"></strong> | IP: <strong id="userIPDisplay"></strong> | 上線時間: <strong id="userLastSeen">載入中...</strong>
      </div>
      <div class="private-toggle">
        <input type="checkbox" id="privateMode">
        <label for="privateMode">私密對話</label>
      </div>
    </header>
    
    <div class="chat-main-area">
        <main id="messages"></main>
        <div id="usersList">
            <h3>訪客列表 (<span id="userCount">0</span>)</h3>
            <ul id="onlineUsers">
                </ul>
        </div>
    </div>
    
    <footer id="footer">
      <div class="input-area">
        <textarea id="input" placeholder="說點什麼…（Enter送出）"></textarea>
        <button onclick="send()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </footer>
</div>

<div class="modal">
  <div class="modal-box">
    <h2>DM｜DateMode 18+ 使用條款</h2>
    <div style="line-height:2;font-size:1.1rem;margin:1.5rem 0;">
      <ul style="text-align:left;margin-left:1.5rem;">
        <li>僅限滿18歲成年人士使用</li>
        <li>嚴禁金錢交易、援交廣告</li>
        <li>禁止散布違法或騷擾內容</li>
        <li>一切言論由使用者自行負責</li>
      </ul>
      <p style="color:#ff6b6b;margin-top:1.8rem;font-weight:bold;">按下同意即表示您已滿18歲</p>
    </div>
    <button onclick="document.querySelector('.modal').remove();showLogin()" 
            style="background:#10b981;width:100%;padding:18px;margin-top:25px;border-radius:20px;font-size:1.2rem;">
      我已滿18歲，同意並進入
    </button>
  </div>
</div>

<div id="login" class="hidden">
  <h1>DM｜DateMode</h1>
  <p>台灣最安全高端匿名交友平台</p>
  
  <div class="ip-box" id="ipInfo">正在取得您的真實位置…</div>
  
  <div id="googleBtn" style="margin:25px auto;"></div>
  
  <input type="text" id="nick" placeholder="輸入暱稱（最多10字）" maxlength="10">
  
  <div class="gender-selection">
      <input type="radio" id="genderMale" name="gender" value="male">
      <label for="genderMale" class="male"><i class="fas fa-mars"></i> 男生</label>
      
      <input type="radio" id="genderFemale" name="gender" value="female">
      <label for="genderFemale" class="female"><i class="fas fa-venus"></i> 女生</label>
  </div>
  
  <div class="room-grid">
    <button class="room-btn" onclick="enter('short')"><i class="fas fa-bolt"></i> 短期約會</button>
    <button class="room-btn" onclick="enter('long')"><i class="fas fa-heart"></i> 長期約會</button>
    <button class="room-btn" onclick="enter('group')"><i class="fas fa-users"></i> 多人聯誼</button>
    <button class="room-btn" onclick="enter('gay')"><i class="fas fa-venus-mars"></i> 男同志</button>
    <button class="room-btn" onclick="enter('lesbian')"><i class="fas fa-venus"></i> 女同志</button>
    <button class="room-btn" onclick="showCities()"><i class="fas fa-map-marker-alt"></i> 依地區</button>
  </div>

  <select id="citySelect" class="hidden" onchange="this.value && enter('city')" 
          style="width:100%;max-width:380px;padding:16px;border-radius:20px;background:rgba(45,27,105,0.6);border:1px solid var(--p);color:white;margin-top:20px;">
    <option value="">選擇縣市…</option>
    <option>台北市</option><option>新北市</option><option>桃園市</option><option>台中市</option><option>台南市</option><option>高雄市</option>
    <option>基隆市</option><option>新竹市</option><option>嘉義市</option><option>新竹縣</option><option>苗栗縣</option><option>彰化縣</option>
    <option>南投縣</option><option>雲林縣</option><option>嘉義縣</option><option>屏東縣</option><option>宜蘭縣</option><option>花蓮縣</option>
    <option>台東縣</option><option>澎湖縣</option><option>金門縣</option><option>連江縣</option>
  </select>
</div>


<script>
// ⭐ 請確保您的 API 網址是正確且可存取的
const API = "https://123gocorp.com/api.php"; 

let room = "", nick = "匿名", googleUser = null, ip = "", city = "未知地區";
let gender = null; 
let lastMessageId = 0;
let lastSeenTime = new Date().toLocaleTimeString('zh-TW');

function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
}

async function getLocation(){
  try{
    const r = await fetch("https://api.ipify.org?format=json");
    const {ip:addr} = await r.json();
    ip = addr;
    const r2 = await fetch(`https://ipapi.co/${ip}/json/`);
    const d = await r2.json();
    city = d.country_name==="Taiwan" ? (d.region || "台灣") : "國外";
    document.getElementById("ipInfo").innerHTML = `
      <i class="fas fa-map-marker-alt"></i> 您目前在：<strong>${city}</strong><br>
      <small style="opacity:0.8;">IP：${ip}</small>
    `;
  }catch(e){
    document.getElementById("ipInfo").textContent = "位置取得失敗";
  }
}

function showLogin(){
  getLocation();
  google.accounts.id.initialize({
    client_id: "1039614426685-4v0g4u1g5p8f0b8gq8v8gq8v8gq8v8gq.apps.googleusercontent.com",
    callback: r=>{
      const p = JSON.parse(atob(r.credential.split('.')[1]));
      googleUser = p;
      nick = p.name;
      document.getElementById("nick").value = nick;
    }
  });
  google.accounts.id.renderButton(document.getElementById("googleBtn"), {theme:"outline", size:"large", shape:"pill"});
  document.getElementById("login").classList.remove("hidden");
}

function showCities(){
  document.getElementById("citySelect").classList.remove("hidden");
}

function enter(r){
  const inputNick = document.getElementById("nick").value.trim();
  const selectedGender = document.querySelector('input[name="gender"]:checked');
  
  if(!inputNick && !googleUser){
    alert("請輸入暱稱或使用 Google 登入");
    return;
  }
  if(!selectedGender){
      alert("請選擇您的性別！");
      return;
  }
  
  nick = (googleUser?.name || inputNick).slice(0,10);
  gender = selectedGender.value; 
  
  if(r==="city"){
    const c = document.getElementById("citySelect").value;
    if(!c){ alert("請選擇縣市"); return; }
    room = "city_"+c;
    document.getElementById("roomTitle").textContent = c + "聊天室";
  }else{
    room = r;
    const names = {short:"短期約會",long:"長期約會",group:"多人聯誼",gay:"男同志",lesbian:"女同志"};
    document.getElementById("roomTitle").textContent = names[r] || "聊天室";
  }
  
  localStorage.setItem("dm_nick", nick);
  localStorage.setItem("dm_gender", gender); 

  lastSeenTime = new Date().toLocaleTimeString('zh-TW');
  document.getElementById("userNickDisplay").textContent = nick + (gender === 'male' ? ' (♂)' : ' (♀)');
  document.getElementById("userIPDisplay").textContent = ip;
  document.getElementById("userLastSeen").textContent = lastSeenTime;

  document.getElementById("login").classList.add("hidden");
  document.getElementById("chat-container").classList.remove("hidden");
  
  load();
  setInterval(load, 3500);
}

function renderUsersList(users) {
    const userList = document.getElementById("onlineUsers");
    const userCount = document.getElementById("userCount");
    
    if (!users || users.length === 0) {
        userCount.textContent = 0;
        userList.innerHTML = '<li>目前沒有其他訪客。</li>';
        return;
    }

    const finalUsers = users;
    finalUsers.sort((a, b) => a.nickname.localeCompare(b.nickname, 'zh-TW'));
    
    userCount.textContent = finalUsers.length;
    userList.innerHTML = finalUsers.map(user => {
        const userGender = user.gender || 'unknown';
        const genderClass = userGender === 'male' ? 'user-gender-male' : 'user-gender-female';
        const genderIcon = userGender === 'male' ? 'fas fa-mars' : 'fas fa-venus';
        const isSelf = user.nickname === nick;

        return `
            <li>
                <span class="user-online-dot"></span>
                <span class="${genderClass}">
                    <i class="${genderIcon}"></i> 
                    ${user.nickname} ${isSelf ? ' (您)' : ''}
                </span>
            </li>
        `;
    }).join('');
}

function renderMessage(msg) {
    const isOwn = msg.nickname === nick;
    const msgGender = msg.gender || gender; 
    
    const avatar = msg.avatar || 'https://via.placeholder.com/150/808080/FFFFFF?text=DM';
    let avatarStyle = '';
    
    const nicknameClass = msgGender === 'male' ? 'nickname-male' : 'nickname-female';
    const nicknameColor = msgGender === 'male' ? 'var(--male)' : 'var(--female)';
    
    const html = `
        <div class="msg ${isOwn ? 'own' : 'other'}">
            <div class="head">
                ${!isOwn ? `<img class="avatar" src="${msg.avatar ? msg.avatar : 'https://via.placeholder.com/46'}" alt="${msg.nickname}" style="${avatarStyle}">` : ''}
                <strong class="${nicknameClass}" style="color: ${nicknameColor};">
                    ${msg.nickname}
                </strong>
            </div>
            <div class="bubble">
                ${msg.message.replace(/\n/g, '<br>')}
                <div class="info">
                    <span>${formatTime(msg.created_at || new Date())}</span> 
                    - ${msg.city || '未知地區'}
                </div>
            </div>
        </div>
    `;
    return html;
}

async function load() {
    try {
        const response = await fetch(`${API}?action=messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room, nickname: nick }) 
        });
        
        const data = await response.json();
        
        if (data.error) {
            console.error('後端錯誤:', data.error);
            return;
        }

        const messages = data.messages || [];
        const onlineUsers = data.users || []; 

        const msgsContainer = document.getElementById("messages");
        
        if (messages.length > 0) {
            renderUsersList(onlineUsers); 
            
            // 由於沒有資料庫 ID，我們使用最後一條訊息的創建時間戳作為 ID 檢查點
            const currentLastId = messages[messages.length - 1].created_at_ts || messages[messages.length - 1].id; 
            
            if (currentLastId !== lastMessageId) {
                msgsContainer.innerHTML = messages.map(renderMessage).join('');
                lastMessageId = currentLastId;
                msgsContainer.scrollTop = msgsContainer.scrollHeight; 
            }
        } else {
             renderUsersList(onlineUsers); 
             msgsContainer.innerHTML = '<div style="text-align:center; color:var(--muted); margin-top:50px;">目前沒有訊息，快來打個招呼吧！</div>';
             lastMessageId = 0;
        }
        
        document.getElementById("online").textContent = `${document.getElementById("userCount").textContent} 人`; 

    } catch (e) {
        console.error("載入訊息失敗:", e);
        document.getElementById("messages").innerHTML = '<div style="text-align:center; color:#ff6b6b; margin-top:50px;">連線到代理服務器失敗，請檢查 API 路徑是否正確。</div>';
    }
}

async function send() {
    const inputField = document.getElementById("input");
    const message = inputField.value.trim();
    if (!message) return;

    try {
        const response = await fetch(`${API}?action=send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                room,
                nickname: nick,
                gender, 
                message: message,
                googleUser,
                ip,
                city,
            })
        });

        const result = await response.json();
        
        if (result.success) {
            inputField.value = '';
            setTimeout(load, 500); 
        } else {
            alert(`發送失敗，請檢查代理 API 回傳錯誤: ${result.error || '未知錯誤'}`);
        }

    } catch (e) {
        console.error("發送訊息失敗:", e);
        alert("網路錯誤或代理 API 連線中斷。");
    }
}


document.addEventListener("keydown",e=>{
    const inputField = document.getElementById("input");
    if(e.key==="Enter" && !e.shiftKey && inputField && document.getElementById("chat-container") && !document.getElementById("chat-container").classList.contains('hidden')){
        e.preventDefault();
        send();
    }
});

if(localStorage.dm_nick) document.getElementById("nick").value=localStorage.dm_nick;
if(localStorage.dm_gender) document.getElementById(`gender${localStorage.dm_gender.charAt(0).toUpperCase() + localStorage.dm_gender.slice(1)}`).checked = true;
</script>
</body>
</html>
