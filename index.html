<!DOCTYPE html>
<html lang="zh-TW">
<head>
<head>
<meta charset="UTF-8">
<title>DM｜DateMode 台灣最大匿名交友</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root{--p:#d8b4fe;--ph:#c084fc;--bg:#0d071a;--card:#1e0d3d;--text:#e9d5ff;--muted:#94a3b8;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Microsoft JhengHei',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;background:radial-gradient(circle at 30% 70%, #2d1b69, var(--bg));}
  header{background:linear-gradient(135deg,#2d1b69,#1e0d3d);padding:1rem;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.7);position:relative;}
  h1{font-size:1.8rem;background:linear-gradient(90deg,var(--p),#e0aaff); -webkit-background-clip:text;color:transparent;}
  #online{display:inline-block;background:rgba(0,0,0,.5);padding:5px 12px;border-radius:20px;margin-left:10px;font-size:0.9rem;}
  #messages{flex:1;overflow-y:auto;padding:1.2rem;display:flex;flex-direction:column;gap:14px;}
  .msg{max-width:80%;word-wrap:break-word;align-self:flex-start;position:relative;}
  .msg.own{align-self:flex-end;}
  .bubble{background:var(--card);padding:15px 20px;border-radius:24px;box-shadow:0 6px 20px rgba(0,0,0,.5);border:1px solid #4c1d95;cursor:pointer;}
  .msg.own .bubble{background:linear-gradient(135deg,var(--p),var(--ph));color:#000;border-bottom-right-radius:6px;}
  .msg.private .bubble{border:2px solid #ffd700 !important;background:#3d2a8e !important;color:#fff;}
  .head{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
  .avatar{width:42px;height:42px;border-radius:50%;border:2px solid var(--p);object-fit:cover;cursor:pointer;transition:.2s;}
  .avatar:hover{transform:scale(1.1);}
  .info{font-size:0.85rem;color:var(--muted);margin-top:8px;}
  .info span{color:var(--ph);font-weight:600;}
  footer{background:var(--card);padding:1rem;border-top:2px solid var(--p);box-shadow:0 -10px 30px rgba(0,0,0,.6);}
  .input-area{display:flex;align-items:center;gap:12px;}
  textarea{flex:1;padding:16px;border-radius:20px;background:#2d1b69;border:1px solid var(--p);color:white;font-size:1.1rem;resize:none;min-height:56px;}
  button{background:var(--p);border:none;width:56px;height:56px;border-radius:50%;font-size:1.6rem;color:#000;cursor:pointer;box-shadow:0 6px 20px rgba(216,180,254,.6);}
  .private-toggle{background:#333;padding:8px 15px;border-radius:30px;font-size:0.9rem;display:flex;align-items:center;gap:8px;position:absolute;right:15px;top:15px;}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.98);display:flex;align-items:center;justify-content:center;z-index:999;}
  .mb{background:var(--card);padding:2.8rem;border-radius:28px;border:2px solid var(--p);max-width:92%;}
  .grid{display:grid;gap:16px;margin-top:25px;grid-template-columns:1fr 1fr;}
  .ip-box{background:#2d1b69;padding:14px;border-radius:14px;margin:15px 0;text-align:center;border:1px solid var(--p);}
  .hidden{display:none !important;}
</style>
</head>
<body>

<!-- 18禁合約 -->
<div class="modal">
  <div class="mb">
    <h2 style="color:#ff6b6b;text-align:center;">DM｜DateMode 使用條款（滿18歲）</h2>
    <div style="line-height:2;font-size:1.05rem;margin:1.5rem 0;">
      <ul><li>僅限滿18歲使用</li><li>嚴禁金錢交易</li><li>禁止違法內容</li></ul>
      <p style="color:#ff6b6b;margin-top:1.5rem;">按下同意即表示您已滿18歲</p>
    </div>
    <button onclick="document.querySelector('.modal').remove();showLogin()" style="background:#10b981;width:100%;padding:16px;border-radius:18px;">我已滿18歲，同意並進入</button>
  </div>
</div>

<!-- 登入頁 -->
<div id="login" class="hidden" style="padding:2rem;text-align:center;flex:1;display:flex;flex-direction:column;justify-content:center;">
  <h1>DM｜DateMode</h1>
  <p style="color:var(--muted);margin:1.5rem 0;">台灣最安全匿名交友平台</p>
  <div class="ip-box" id="ipInfo">正在取得位置…</div>
  <div id="googleBtn" style="margin:20px auto;"></div>
  <input type="text" id="nick" placeholder="輸入暱稱（最多10字）" maxlength="10" style="text-align:center;margin:15px 0;">
  <p id="error" style="color:#ff6b6b;margin:10px 0;"></p>
  <div class="grid">
    <button onclick="enter('short')">短期約會</button>
    <button onclick="enter('long')">長期約會</button>
    <button onclick="enter('group')">多人聯誼</button>
    <button onclick="enter('gay')">男同志</button>
    <button onclick="enter('lesbian')">女同志</button>
    <button onclick="showCities()">依地區</button>
  </div>
  <select id="citySelect" class="hidden" style="margin-top:15px;padding:14px;border-radius:14px;background:#2d1b69;color:white;border:1px solid var(--p);">
    <option value="">選擇縣市…</option>
    <option>台北市</option><option>新北市</option><option>桃園市</option><option>台中市</option><option>台南市</option><option>高雄市</option>
    <option>基隆市</option><option>新竹市</option><option>嘉義市</option><option>新竹縣</option><option>苗栗縣</option><option>彰化縣</option>
    <option>南投縣</option><option>雲林縣</option><option>嘉義縣</option><option>屏東縣</option><option>宜蘭縣</option><option>花蓮縣</option>
    <option>台東縣</option><option>澎湖縣</option><option>金門縣</option><option>連江縣</option>
  </select>
  <button id="cityBtn" class="hidden" onclick="enterCity()" style="margin-top:15px;">進入</button>
</div>

<header id="header" class="hidden">
  <h1 id="roomTitle">聊天室</h1>
  <div id="online">0 人</div>
  <div class="private-toggle">
    <input type="checkbox" id="privateMode">
    <label for="privateMode">私密對話</label>
  </div>
</header>
<main id="messages"></main>
<footer id="footer" class="hidden">
  <div class="input-area">
    <textarea id="input" placeholder="說點什麼…（Enter送出）"></textarea>
    <button onclick="send()">Send</button>
  </div>
</footer>

<script>
// 你的正式 API 域名
const API = "https://123gocorp.com";

let room = "", nick = "匿名", googleUser = null, ip = "", city = "未知地區", privateTo = null;

async function getLocation(){
  try{
    const r = await fetch("https://api.ipify.org?format=json");
    const d = await r.json();
    ip = d.ip;
    const r2 = await fetch(`https://ipapi.co/${ip}/json/`);
    const loc = await r2.json();
    city = loc.country_name==="Taiwan" ? (loc.region||"台灣") : "國外";
    document.getElementById("ipInfo").innerHTML = `<i class="fas fa-map-marker-alt"></i> 您的位置：${city} (IP: ${ip})`;
  }catch(e){
    document.getElementById("ipInfo").textContent = "位置取得失敗";
  }
}

function showLogin(){
  getLocation();
  google.accounts.id.initialize({
    client_id: "1039614426685-4v0g4u1g5p8f0b8gq8v8gq8v8gq8v8gq.apps.googleusercontent.com",
    callback: r=>{
      const p = JSON.parse(atob(r.credential.split('.')[1]));
      googleUser = p;
      nick = p.name;
      document.getElementById("nick").value = nick;
    }
  });
  google.accounts.id.renderButton(document.getElementById("googleBtn"), {theme:"outline", size:"large"});
  document.getElementById("login").classList.remove("hidden");
}

function showCities(){
  document.getElementById("citySelect").classList.remove("hidden");
  document.getElementById("cityBtn").classList.remove("hidden");
}

function enterCity(){
  const c = document.getElementById("citySelect").value;
  if(!c) return document.getElementById("error").textContent="請選擇縣市";
  enter("city_"+c);
}

function enter(r){
  const n = document.getElementById("nick").value.trim() || googleUser?.name;
  if(!n){ document.getElementById("error").textContent="請輸入暱稱或Google登入"; return; }
  nick = n.slice(0,10);
  room = r.startsWith("city_")?r:r;
  localStorage.setItem("dm_nick",nick);
  document.getElementById("login").classList.add("hidden");
  document.getElementById("header").classList.remove("hidden");
  document.getElementById("footer").classList.remove("hidden");
  document.getElementById("roomTitle").textContent = {
    short:"短期約會",long:"長期約會",group:"多人聯誼",gay:"男同志",lesbian:"女同志"
  }[r] || room.replace("city_","")+"聊天室";
  load();
  setInterval(load,3500);
}

async function load(){
  const res = await fetch(`${API}/api.php?action=messages`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({room})
  });
  const msgs = await res.json();
  document.getElementById("online").textContent = new Set(msgs.map(m=>m.nickname)).size + " 人";
  
  document.getElementById("messages").innerHTML = msgs.map(m=>{
    const isPrivate = m.private_to && (m.nickname===nick || m.private_to===nick);
    const isMine = m.nickname===nick;
    if(m.private_to && !isPrivate) return ""; // 只有當事人看得到私密
    
    return `<div class="msg ${isMine?'own':''} ${m.private_to?'private':''}" onclick="setPrivate('${m.nickname}')">
      <div class="head">
        ${m.avatar?`<img src="${m.avatar}" class="avatar">`:`<div class="avatar" style="background:#7e57c2;display:grid;place-items:center;color:white;font-weight:bold;">${m.nickname[0]}</div>`}
        <div>
          <div class="bubble">${m.message.replace(/\n/g,'<br>')}</div>
          <div class="info">
            ${m.nickname} ${m.private_to?`<i class="fas fa-lock" style="color:#ffd700"></i> 私密`:''}
            <span>${m.city}</span> · ${new Date(m.created_at).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'})}
          </div>
        </div>
      </div>
    </div>`;
  }).join("");
  document.getElementById("messages").scrollTop = 1e9;
}

function setPrivate(target){
  if(!document.getElementById("privateMode").checked) return;
  privateTo = privateTo===target?null:target;
  alert(privateTo?`已切換為與 ${target} 私密對話`:"已取消私密模式");
}

async function send(){
  const text = document.getElementById("input").value.trim();
  if(!text) return;
  const isPrivate = document.getElementById("privateMode").checked;
  await fetch(`${API}/api.php?action=send`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({room,nickname:nick,message:text,googleUser,ip,city,private_to:isPrivate?privateTo:null})
  });
  document.getElementById("input").value="";
  load();
}

document.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey&&document.getElementById("input")){e.preventDefault();send()}});
if(localStorage.dm_nick) document.getElementById("nick").value=localStorage.dm_nick;
</script>
</body>
</html>
