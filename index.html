<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>DM｜DateMode 台灣高端匿名交友</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root{
    --p:#c084fc;--ph:#e9d5ff;--bg:#0a0619;--card:#1a0f38;--glass:rgba(30,15,56,0.65);
    --text:#e0d0ff;--muted:#b19cd9;--glow:rgba(192,132,252,0.4);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    font-family:'Microsoft JhengHei','Noto Sans TC',sans-serif;
    background:var(--bg);
    color:var(--text);
    height:100vh;
    overflow:hidden;
    background:radial-gradient(circle at 20% 80%, #2a1a5e, #0a0619);
  }

  /* 18禁彈窗 – 頂級質感 */
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,0.96);display:flex;align-items:center;justify-content:center;z-index:999;
    backdrop-filter:blur(12px);
  }
  .modal-box{
    background:var(--glass);padding:3rem 2.5rem;border-radius:32px;
    border:1px solid var(--glow);box-shadow:0 25px 80px rgba(192,132,252,0.35);
    max-width:440px;width:92%;text-align:center;
  }
  .modal-box h2{
    background:linear-gradient(90deg,#ff6b6b,#ff8e8e);
    -webkit-background-clip:text;color:transparent;
    font-size:2rem;margin-bottom:1.2rem;
  }

  /* 登入選單 – 極致優雅 */
  #login{
    padding:2rem 1.5rem;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;
    background:linear-gradient(to bottom, rgba(26,15,56,0.9), var(--bg));
  }
  #login h1{
    font-size:2.6rem;margin-bottom:0.4rem;
    background:linear-gradient(90deg,#c084fc,#e0aaff,#f8b7ff);
    -webkit-background-clip:text;color:transparent;letter-spacing:3px;
  }
  #login > p{
    color:var(--muted);margin:1.2rem 0 2rem;font-size:1.15rem;opacity:0.9;
  }

  /* 真實 IP 顯示框 */
  .ip-box{
    background:rgba(192,132,252,0.15);
    border:1px solid rgba(192,132,252,0.5);
    padding:16px 24px;border-radius:20px;margin:25px 0;
    font-size:1.05rem;backdrop-filter:blur(10px);
    box-shadow:0 8px 25px rgba(0,0,0,0.3);
  }

  /* 超精緻按鈕群 */
  .room-grid{
    display:grid;grid-template-columns:repeat(2,1fr);gap:20px;width:100%;max-width:460px;margin:35px 0;
  }
  .room-btn{
    background:linear-gradient(135deg,rgba(192,132,252,0.22),rgba(224,170,255,0.12));
    border:1px solid rgba(192,132,252,0.6);
    color:white;padding:24px 18px;border-radius:26px;
    font-size:1.18rem;font-weight:600;letter-spacing:1.5px;
    transition:all .4s ease;box-shadow:0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter:blur(12px);
  }
  .room-btn:hover{
    transform:translateY(-10px) scale(1.03);
    box-shadow:0 20px 50px rgba(192,132,252,0.5);
    border-color:var(--p);
  }
  .room-btn i{margin-right:10px;font-size:1.4rem;}

  /* 退出按鈕 */
  #backBtn{
    position:fixed;top:20px;left:20px;z-index:99;
    background:rgba(0,0,0,0.5);border:none;color:white;padding:12px 18px;
    border-radius:50px;font-size:1rem;cursor:pointer;backdrop-filter:blur(8px);
    box-shadow:0 4px 15px rgba(0,0,0,0.4);
  }
  #backBtn:hover{background:var(--p);color:#000;}

  /* 聊天介面 */
  header{
    background:var(--card);padding:1.1rem;text-align:center;position:relative;
    box-shadow:0 12px 35px rgba(0,0,0,0.7);backdrop-filter:blur(10px);
  }
  #roomTitle{
    font-size:1.75rem;background:linear-gradient(90deg,#c084fc,#e0aaff);
    -webkit-background-clip:text;color:transparent;
  }
  #online{
    position:absolute;right:16px;top:50%;transform:translateY(-50%);
    background:rgba(192,132,252,0.35);padding:7px 16px;border-radius:30px;font-size:0.95rem;
  }

  #messages{
    flex:1;overflow-y:auto;padding:1.6rem 1.2rem;display:flex;flex-direction:column;gap:18px;
    background:linear-gradient(to bottom, rgba(26,15,56,0.5), var(--bg));
  }
  .msg{
    max-width:78%;align-self:flex-start;animation:msgIn 0.5s ease-out;
  }
  .msg.own{align-self:flex-end;}
  @keyframes msgIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:none;}}
  .bubble{
    background:var(--card);padding:16px 22px;border-radius:28px;
    box-shadow:0 8px 28px rgba(0,0,0,0.5);border:1px solid rgba(192,132,252,0.3);
  }
  .msg.own .bubble{
    background:linear-gradient(135deg,#d8b4fe,#c084fc);color:#000;
    border-bottom-right-radius:8px;
  }
  .msg.other .bubble{border-bottom-left-radius:8px;}
  .head{display:flex;align-items:center;gap:14px;margin-bottom:8px;}
  .avatar{
    width:46px;height:46px;border-radius:50%;border:2px solid var(--p);object-fit:cover;
  }
  .info{font-size:0.9rem;color:var(--muted);margin-top:10px;}
  .info span{color:#faf5ff;font-weight:600;}

  footer{
    background:var(--card);padding:1.2rem;border-top:2px solid var(--p));
    box-shadow:0 -12px 40px rgba(0,0,0,0.7);
  }
  .input-area{display:flex;align-items:end;gap:14px;}
  textarea{
    flex:1;padding:18px;border-radius:26px;background:rgba(45,27,105,0.7);
    border:1px solid var(--p);color:white;font-size:1.1rem;min-height:56px;
    resize:none;backdrop-filter:blur(8px);
  }
  textarea:focus{outline:none;background:rgba(61,42,142,0.9);}
  button{
    background:var(--p);border:none;width:60px;height:60px;border-radius:50%;
    font-size:1.8rem;color:#000;cursor:pointer;
    box-shadow:0 8px 30px rgba(192,132,252,0.6);transition:.3s;
  }
  button:hover{transform:scale(1.15);}
  .private-toggle{
    position:absolute;right:16px;top:50%;transform:translateY(-50%);
    background:rgba(0,0,0,0.5);padding:8px 16px;border-radius:30px;
    font-size:0.95rem;display:flex;align-items:center;gap:8px;
    backdrop-filter:blur(8px);
  }
  .hidden{display:none !important;}
</style>
</head>
<body>

<button id="backBtn" class="hidden" onclick="location.reload()">
  <i class="fas fa-arrow-left"></i> 退出房間
</button>

<!-- 18禁彈窗 -->
<div class="modal">
  <div class="modal-box">
    <h2>DM｜DateMode 18+ 使用條款</h2>
    <div style="line-height:2;font-size:1.1rem;margin:1.5rem 0;">
      <ul style="text-align:left;margin-left:1.5rem;">
        <li>僅限滿18歲成年人士使用</li>
        <li>嚴禁金錢交易、援交廣告</li>
        <li>禁止散布違法或騷擾內容</li>
        <li>一切言論由使用者自行負責</li>
      </ul>
      <p style="color:#ff6b6b;margin-top:1.8rem;font-weight:bold;">按下同意即表示您已滿18歲</p>
    </div>
    <button onclick="document.querySelector('.modal').remove();showLogin()" 
            style="background:#10b981;width:100%;padding:18px;margin-top:25px;border-radius:20px;font-size:1.2rem;">
      我已滿18歲，同意並進入
    </button>
  </div>
</div>

<!-- 登入選單 -->
<div id="login" class="hidden">
  <h1>DM｜DateMode</h1>
  <p>台灣最安全高端匿名交友平台</p>
  
  <div class="ip-box" id="ipInfo">正在取得您的真實位置…</div>
  
  <div id="googleBtn" style="margin:25px auto;"></div>
  
  <input type="text" id="nick" placeholder="輸入暱稱（最多10字）" maxlength="10" 
         style="width:100%;max-width:380px;padding:16px;border-radius:20px;background:rgba(45,27,105,0.6);border:1px solid var(--p);text-align:center;margin:20px 0;font-size:1.1rem;">
  
  <div class="room-grid">
    <button class="room-btn" onclick="enter('short')"><i class="fas fa-bolt"></i> 短期約會</button>
    <button class="room-btn" onclick="enter('long')"><i class="fas fa-heart"></i> 長期約會</button>
    <button class="room-btn" onclick="enter('group')"><i class="fas fa-users"></i> 多人聯誼</button>
    <button class="room-btn" onclick="enter('gay')"><i class="fas fa-venus-mars"></i> 男同志</button>
    <button class="room-btn" onclick="enter('lesbian')"><i class="fas fa-venus"></i> 女同志</button>
    <button class="room-btn" onclick="showCities()"><i class="fas fa-map-marker-alt"></i> 依地區</button>
  </div>

  <select id="citySelect" class="hidden" style="width:100%;max-width:380px;padding:16px;border-radius:20px;background:rgba(45,27,105,0.6);border:1px solid var(--p);color:white;margin-top:20px;">
    <option value="">選擇縣市…</option>
    <!-- 台灣22縣市 -->
    <option>台北市</option><option>新北市</option><option>桃園市</option><option><option>台中市</option><option>台南市</option><option>高雄市</option>
    <option>基隆市</option><option>新竹市</option><option>嘉義市</option><option>新竹縣</option><option>苗栗縣</option><option>彰化縣</option>
    <option>南投縣</option><option>雲林縣</option><option>嘉義縣</option><option>屏東縣</option><option>宜蘭縣</option><option>花蓮縣</option>
    <option>台東縣</option><option>澎湖縣</option><option>金門縣</option><option>連江縣</option>
  </select>
</div>

<!-- 聊天介面 -->
<header id="header" class="hidden">
  <button id="backBtn" onclick="location.reload()">退出房間</button>
  <h1 id="roomTitle">聊天室</h1>
  <div id="online">0 人</div>
  <div class="private-toggle">
    <input type="checkbox" id="privateMode">
    <label for="privateMode">私密對話</label>
  </div>
</header>
<main id="messages"></main>
<footer class="hidden" id="footer">
  <div class="input-area">
    <textarea id="input" placeholder="說點什麼…（Enter送出）"></textarea>
    <button onclick="send()"><i class="fas fa-paper-plane"></i></button>
  </div>
</footer>

<script>
// 你的正式後端
const API = "https://123gocorp.com";

let room = "", nick = "匿名", googleUser = null, ip = "", city = "未知地區", privateTo = null;

async function getLocation(){
  try{
    const r = await fetch("https://api.ipify.org?format=json");
    const {ip:addr} = await r.json();
    ip = addr;
    const r2 = await fetch(`https://ipapi.co/${ip}/json/`);
    const d = await r2.json();
    city = d.country_name==="Taiwan" ? (d.region || "台灣") : "國外";
    document.getElementById("ipInfo").innerHTML = `
      <i class="fas fa-map-marker-alt"></i> 您目前在：<strong>${city}</strong><br>
      <small style="opacity:0.8;">IP：${ip}</small>
    `;
  }catch(e){
    document.getElementById("ipInfo").textContent = "位置取得失敗";
  }
}

function showLogin(){
  getLocation();
  google.accounts.id.initialize({
    client_id: "1039614426685-4v0g4u1g5p8f0b8gq8v8gq8v8gq8v8gq.apps.googleusercontent.com",
    callback: r=>{
      const p = JSON.parse(atob(r.credential.split('.')[1]));
      googleUser = p;
      nick = p.name;
      document.getElementById("nick").value = nick;
    }
  });
  google.accounts.id.renderButton(document.getElementById("googleBtn"), {theme:"outline", size:"large", shape:"pill"});
  document.getElementById("login").classList.remove("hidden");
}

function showCities(){
  document.getElementById("citySelect").classList.remove("hidden");
}

function enter(r){
  const inputNick = document.getElementById("nick").value.trim();
  if(!inputNick && !googleUser){
    alert("請輸入暱稱或使用 Google 登入");
    return;
  }
  nick = (googleUser?.name || inputNick).slice(0,10);
  if(r==="city"){
    const c = document.getElementById("citySelect").value;
    if(!c){ alert("請選擇縣市"); return; }
    room = "city_"+c;
    document.getElementById("roomTitle").textContent = c + "聊天室";
  }else{
    room = r;
    const names = {short:"短期約會",long:"長期約會",group:"多人聯誼",gay:"男同志",lesbian:"女同志"};
    document.getElementById("roomTitle").textContent = names[r] || "聊天室";
  }
  localStorage.setItem("dm_nick",nick);
  document.getElementById("login").classList.add("hidden");
  document.getElementById("header").classList.remove("hidden");
  document.getElementById("footer").classList.remove("hidden");
  document.getElementById("backBtn").classList.remove("hidden");
  load();
  setInterval(load,3500);
}

// 其餘 load() / send() 函數與上一版完全相同（省略以免太長）
async function load(){ /* 同上一版 */ }
async function send(){ /* 同上一版 */ }
document.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey&&document.getElementById("input")){e.preventDefault();send()}});
if(localStorage.dm_nick) document.getElementById("nick").value=localStorage.dm_nick;
</script>
</body>
</html>
