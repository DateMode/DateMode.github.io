<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>DM聊天室｜DateMode</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<style>
  :root{--p:#ff3366;--bg:#000;--card:#111;}
  body{font-family:'Microsoft JhengHei',sans-serif;background:var(--bg);color:#fff;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at center,#220022,#000);}
  .box{background:var(--card);border:2px solid var(--p);padding:2.5rem;border-radius:20px;width:92%;max-width:460px;box-shadow:0 0 40px var(--p);}
  h1{color:var(--p);text-align:center;text-shadow:0 0 20px var(--p);}
  input,button,textarea{width:100%;padding:14px;margin:10px 0;border-radius:12px;border:1px solid var(--p);background:var(--bg);color:#fff;font-size:1.1rem;}
  button{background:var(--p);color:#000;font-weight:bold;cursor:pointer;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .hidden{display:none;}
  #chat{height:96vh;max-width:900px;display:flex;flex-direction:column;}
  #msg{flex:1;overflow-y:auto;background:#000;padding:20px;border-radius:15px;margin:10px 0;}
  .me{text-align:right;}
  .me div{background:var(--p);color:#000;display:inline-block;padding:12px 20px;border-radius:20px;max-width:80%;word-break:break-all;}
  .other div{background:#333;color:#fff;display:inline-block;padding:12px 20px;border-radius:20px;max-width:80%;word-break:break-all;}
</style>
</head>
<body>

<div class="box" id="login">
  <h1>DM聊天室｜DateMode</h1>
  <input type="password" id="decryptPass" placeholder="輸入解密密碼才能看歷史訊息" autocomplete="off">
  <input type="text" id="nick" placeholder="暱稱（最多10字）" maxlength="10">
  <div class="grid">
    <button onclick="enter('public')">多人聯誼</button>
    <button onclick="enter('gay')">男同志</button>
    <button onclick="enter('lesbian')">女同志</button>
    <button onclick="enter('taiwan')">全台縣市</button>
  </div>
</div>

<div class="box hidden" id="chat">
  <h2 id="title" style="text-align:center;color:var(--p);"></h2>
  <div id="msg"></div>
  <div style="display:flex;">
    <textarea id="input" placeholder="輸入訊息…（Enter送出）" style="height:100px;"></textarea>
    <button onclick="send()">送出</button>
  </div>
</div>

<script>
let room = "", nick = "";
window.DECRYPT_KEY = "";

function enter(r){
  const pass = document.getElementById("decryptPass").value.trim();
  if(!pass) return alert("請輸入解密密碼！");
  nick = document.getElementById("nick").value.trim() || "匿名";
  if(nick.length > 10) return alert("暱稱最多10字");

  room = r;
  window.DECRYPT_KEY = pass; // 存在記憶體，不寫進任何地方

  document.getElementById("login").classList.add("hidden");
  document.getElementById("chat").classList.remove("hidden");
  document.getElementById("title").innerHTML = {
    public:"多人聯誼房", gay:"男同志專區", lesbian:"女同志專區", taiwan:"全台縣市房"
  }[r] + "　<span id='online'>0</span>人線上";

  load();
  setInterval(load, 4000);
}

async function load(){
  try{
    const res = await fetch("record.json?t="+Date.now());
    const data = await res.json();
    const msgs = data[room] || [];
    const html = msgs.map(cipher => {
      try{
        const bytes = CryptoJS.AES.decrypt(cipher, window.DECRYPT_KEY);
        const plain = bytes.toString(CryptoJS.enc.Utf8);
        if(!plain) return "";
        const m = JSON.parse(plain);
        return `<div class="${m.nick===nick?'me':'other'}">
          <small style="color:#aaa;">${m.nick} ${m.time}</small>
          <div>${m.text.replace(/\n/g,'<br>')}</div>
        </div>`;
      }catch(e){ return "<small style='color:#f66;'>[解密失敗]</small>" }
    }).join("");
    document.getElementById("msg").innerHTML = html;
    document.getElementById("msg").scrollTop = 1e9;
    document.getElementById("online").textContent = new Set(msgs.map(cipher=>{
      try{
        const p = CryptoJS.AES.decrypt(cipher, window.DECRYPT_KEY).toString(CryptoJS.enc.Utf8);
        return JSON.parse(p).nick;
      }catch(e){return ""}
    })).size;
  }catch(e){}
}

async function send(){
  const text = document.getElementById("input").value.trim();
  if(!text) return;
  const plain = JSON.stringify({
    nick,
    text,
    time: new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'})
  });

  await fetch("https://api.github.com/repos/datemode/datemode.github.io/dispatches",{
    method:"POST",
    headers:{
      "Accept":"application/vnd.github.v3+json",
      "Authorization":"token "+atob("Z2hwX2d0MWdBWExMS1lXVzd6MlFTVXNJQThxYjd6STFBMkxkZHI4")
    },
    body:JSON.stringify({
      "event_type":"chat-update",
      "client_payload":{room, plain}
    })
  });
  document.getElementById("input").value="";
  setTimeout(load, 800);
}

// Enter 送出
document.getElementById("input")?.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

// 記住暱稱
if(localStorage.nick) document.getElementById("nick").value = localStorage.nick;
document.getElementById("nick").addEventListener("change",()=>localStorage.nick=document.getElementById("nick").value);
</script>
</body>
</html>
