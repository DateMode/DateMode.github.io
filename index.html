<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>台灣最大聊天室平台</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root {
    --primary: #8b5cf6;
    --bg: #0f172a;
    --card: #1e293b;
    --text: #e2e8f0;
  }
  body { 
    font-family: 'Microsoft JhengHei', sans-serif; 
    background: linear-gradient(135deg, #1e1b4b, #0f172a); 
    color: var(--text); 
    margin:0; height:100vh; 
    display:flex; align-items:center; justify-content:center;
  }
  .container { 
    background:var(--card); padding:2rem; border-radius:20px; 
    box-shadow:0 20px 50px rgba(0,0,0,0.5); width:90%; max-width:420px;
  }
  h1 { text-align:center; color:var(--primary); margin-bottom:1.5rem; }
  input, select, button {
    width:100%; padding:12px; margin:10px 0; border-radius:12px; border:none;
    font-size:1rem;
  }
  input, select { background:#334155; color:white; }
  button { 
    background:var(--primary); color:white; font-weight:bold; 
    cursor:pointer; transition:0.3s; margin-top:20px;
  }
  button:hover { background:#7c3aed; transform:translateY(-3px); }
  .room-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
  .hidden { display:none; }
  .online { text-align:center; color:#94a3b8; font-size:0.9rem; margin-top:15px; }
</style>
</head>
<body>

<div class="container" id="loginBox">
  <h1><i class="fas fa-heart"></i> 台灣最大聊天室</h1>
  <p style="text-align:center;color:#94a3b8;">請先輸入暱稱才能進入喔～</p>
  
  <input type="text" id="nickname" placeholder="暱稱（最多20個字）" maxlength="20">
  <div style="font-size:0.9rem;color:#f87171;text-align:center;" id="nameError"></div>
  
  <hr style="margin:20px 0; border-color:#334155;">
  <p style="text-align:center;">選擇聊天室</p>
  
  <div class="room-grid">
    <button onclick="enterRoom('public')">多人聯誼</button>
    <button onclick="enterRoom('gay')">男同志</button>
    <button onclick="enterRoom('lesbian')">女同志</button>
    <button onclick="showCities()">台灣縣市</button>
  </div>

  <select id="citySelect" class="hidden"></select>
  <button id="enterCityBtn" class="hidden" onclick="enterCityRoom()">進入縣市聊天室</button>
</div>

<!-- 這裡會動態載入聊天室畫面 -->
<div id="chatApp" class="hidden"></div>

<script>
// ==== 你的 GitHub 資訊（改成你自己的）====
const GITHUB_REPO = "https://datemode.github.io/"; // 例如：sql-tech/taiwan-chat
const GITHUB_TOKEN = "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"; // 只需要 repo 權限即可
const FILE_PATH = "record.json;

// ==== 台灣縣市列表 ====
const cities = ["台北市","新北市","桃園市","台中市","台南市","高雄市","基隆市","新竹市","嘉義市",
  "新竹縣","苗栗縣","彰化縣","南投縣","雲林縣","嘉義縣","屏東縣","宜蘭縣","花蓮縣","台東縣",
  "澎湖縣","金門縣","連江縣"];

// ==== 檢查暱稱 ====
function validateNickname(name) {
  if (!name.trim()) return "暱稱不能空白";
  if (/[^\u4e00-\u9fa5a-zA-Z0-9]/.test(name)) return "只能用中文、英文、數字";
  if (name.length > 20) return "最多20個字";
  return "";
}

// ==== 進入一般聊天室 ====
function enterRoom(room) {
  const nick = document.getElementById("nickname").value.trim();
  const err = validateNickname(nick);
  if (err) {
    document.getElementById("nameError").textContent = err;
    return;
  }
  document.getElementById("nameError").textContent = "";
  localStorage.setItem("chat_nickname", nick);
  loadChatInterface(room, nick);
}

// ==== 顯示縣市選單 ====
function showCities() {
  const select = document.getElementById("citySelect");
  select.innerHTML = cities.map(c => `<option>${c}</option>`).join("");
  select.classList.remove("hidden");
  document.getElementById("enterCityBtn").classList.remove("hidden");
}

// ==== 進入縣市聊天室 ====
function enterCityRoom() {
  const city = document.getElementById("citySelect").value;
  const nick = document.getElementById("nickname").value.trim();
  const err = validateNickname(nick);
  if (err) { document.getElementById("nameError").textContent = err; return; }
  localStorage.setItem("chat_nickname", nick);
  loadChatInterface("city_"+city, nick);
}

// ==== 主聊天室介面 ====
function loadChatInterface(roomId, nickname) {
  document.getElementById("loginBox").classList.add("hidden");
  
  const html = `
    <div class="container" style="height:95vh;max-width:800px;display:flex;flex-direction:column;">
      <h2 style="text-align:center;">${getRoomName(roomId)}　<span id="onlineCount">0</span> 人上線</h2>
      <div id="messages" style="flex:1;overflow-y:auto;padding:10px;background:#0f172a;border-radius:15px;"></div>
      <div style="display:flex;margin-top:10px;">
        <textarea id="msgInput" placeholder="說點什麼…" style="flex:1;border-radius:12px;"></textarea>
        <button onclick="sendMessage()" style="width:70px;margin-left:8px;">送出</button>
      </div>
    </div>`;
  
  const app = document.getElementById("chatApp");
  app.innerHTML = html;
  app.classList.remove("hidden");

  window.currentRoom = roomId;
  window.nickname = nickname;
  
  loadMessages();
  setInterval(loadMessages, 3000); // 每3秒更新一次
}

// 房間中文名稱
function getRoomName(id) {
  const map = {
    public: "多人聯誼聊天室",
    gay: "男同志聊天室",
    lesbian: "女同志聊天室"
  };
  if (id.startsWith("city_")) return id.replace("city_","") + "聊天室";
  return map[id] || id;
}

// ==== 讀取訊息 ====
async function loadMessages() {
  try {
    const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`);
    const data = await res.json();
    const content = JSON.parse(atob(data.content));
    
    const roomMsgs = content[window.currentRoom] || [];
    const box = document.getElementById("messages");
    box.innerHTML = roomMsgs.map(m => `
      <div style="margin:8px 0;${m.nick===window.nickname?'text-align:right;':''}">
        <div style="font-size:0.8rem;color:#94a3b8;">${m.nick}　${m.time}</div>
        <div style="display:inline-block;background:${m.nick===window.nickname?'#8b5cf6':'#334155'};padding:10px 15px;border-radius:18px;max-width:80%;word-wrap:break-word;">
          ${m.text.replace(/\n/g,'<br>')}
        </div>
      </div>`).join("");
    
    box.scrollTop = box.scrollHeight;
    document.getElementById("onlineCount").textContent = new Set(roomMsgs.map(m=>m.nick)).size;
  } catch(e) {
    console.log("載入失敗，可能是第一次使用");
  }
}

// ==== 送出訊息 ====
async function sendMessage() {
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if (!text) return;
  
  try {
    // 先下載現有 record.json
    let fileData = { public: [], gay: [], lesbian: [] };
    for (let c of cities) fileData["city_"+c] = [];
    
    try {
      const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`, {
        headers: { Authorization: `token ${GITHUB_TOKEN}` }
      });
      const data = await res.json();
      Object.assign(fileData, JSON.parse(atob(data.content)));
    } catch(e) {}

    // 加入新訊息
    const msg = {
      nick: window.nickname,
      text,
      time: new Date().toLocaleString('zh-TW').slice(5, -3) // 去掉年份與秒
    };
    
    if (!fileData[window.currentRoom]) fileData[window.currentRoom] = [];
    fileData[window.currentRoom].push(msg);
    
    // 限制每房最多 500 筆（避免檔案太大）
    if (fileData[window.currentRoom].length > 500) {
      fileData[window.currentRoom] = fileData[window.currentRoom].slice(-500);
    }

    // 上傳回去
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(fileData, null, 2))));
    
    await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`, {
      method: "PUT",
      headers: {
        Authorization: `token ${GITHUB_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "update chat record",
        content: content,
        sha: (await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`, {
          headers: { Authorization: `token ${GITHUB_TOKEN}` }
        }).then(r=>r.json()).catch(()=>null))?.sha || undefined
      })
    });
    
    input.value = "";
    loadMessages();
  } catch(e) {
    alert("送出失敗，請確認網路或 Token 權限");
  }
}

// ==== 頁面載入時檢查是否有記住的暱稱 ====
window.onload = () => {
  const saved = localStorage.getItem("chat_nickname");
  if (saved) document.getElementById("nickname").value = saved;
};
</script>

</body>
</html>
